---
slug: manage-s3-costs
title: Managing S3 Costs with Inventory and Lifecycle Policies
meta_title: Manage S3 Costs with Inventory and Lifecycle Policies
description: Discover strategies to optimize Amazon S3 costs by leveraging inventory exports and lifecycle policies for automated storage management.
date: 2025-01-14
image: /images/blog/9999-s3-costs.jpg
category: cloud_devops
tags: [AWS, S3]
draft: false
---

<script type="module" src="/js/posts/9999-plots-s3-costs.js"></script>

## 0. Motivation

Amazon S3 is a powerful, scalable storage solution that is integral to many workflows. However, storage costs can quickly accumulate, especially when managing large datasets. After migrating some of our jobs from EMR to ECS, we noticed that S3 storage became our largest expense.

By analyzing our storage usage and implementing targeted strategies, we managed to reduce our S3 costs to a third, as shown in the plot below. 

<canvas id="plot-s3-costs" style="width:100%;height:300px;"></canvas>

<Notice type="success" className="mt-6">
  This guide outlines how to export an S3 Inventory and implement Lifecycle Policies to track and optimize your storage expenses effectively.
</Notice>

## 1. Categoryzing S3 costs

### 1.1. Discover S3 costs with Cost Explorer

The first thing you need to do is to check your AWS costs by Service. This way you can see where you should focus your efforts in order to reduce costs.
In our case, after reducing EMR costs, S3 became the next clear objective:

<div class="border-2 rounded-md">
  ![AWS Montly Costs by Service](../../images/posts/2025/9999-aws-costs-by-service.png)
</div>

<Notice type="warning" className="mt-6">
  You should focus first on the AWS service with the biggest cost. Focus only on S3 if you have already addressed other services with bigger costs.
</Notice>

Once you are sure you want to reduce S3 costs, you should check what you are paying for:

<div class="border-2 rounded-md">
  ![S3 Daily Costs by Usage type](../../images/posts/2025/9999-s3-costs-by-usage-type.png)
</div>

In our case it's for data we are storing but in other companies I've seen an abnormally high cost allocated to requests.
That usually happen when you have very small files in the datalake that you need to compact.

<Notice type="info">
  If you are paying a lot for S3 requests you should see how to compact data files at <FancyLink linkText="Solving the probem with small files in the Data Lake" url="https://villoro.com/blog/solving-problem-small-files-data-lake/" dark="true"/>.
</Notice>

### 1.2. Create an S3 Inventory Configuration

**S3 Inventory** is a feature in Amazon S3 that generates a scheduled report containing a comprehensive list of objects in a bucket, along with their metadata, enabling you to analyze and manage storage efficiently.

The steps to set it up are:

1. **Access the S3 Console:**
   Log in to the AWS Management Console and navigate to the S3 service.

2. **Select Your Bucket:**
   Choose the bucket for which you want to create an inventory report.

3. **Go to Management:**
   In the bucket’s dashboard, select the **Management** tab and scroll down to the **Inventory** section.

4. **Create Inventory Configuration:**
   * Click **Create Inventory Configuration**.
   * Provide a unique name for your inventory.
   * Specify the **destination bucket** where the inventory report will be delivered.

5. **Select Report Content:**
   * Choose the **frequency** of the report: Daily or Weekly.
   * Select the **file format**: Since you will be exporting a lot of data, I suggest you export it as `parquet`.
   * Specify the **fields** to include. I suggest you at least include object `size`, `storage class` and `last modified` date.

6. **Review and Save:**
   * Review your configuration.
   * Save it by clicking **Create**.

Regarding the destination path, notice that some folder will be added automatically to it. For example if we have a bucket named `villoro` and we set `destination_path=s3://villoro/s3_inventory` the data will end up at `s3://villoro/s3_inventory/villoro/villoro_inventory/` (the bucket name and the inventory name are appended).

<Notice type="info">
  The first report will be done within 48h and the next ones will be done each day or monday (depending on the frequency you chose).
</Notice>

### 1.3. Accessing the S3 inventory

The S3 inventory follows a non conventional structure. As mentioned, it will be exported to `destination_path/bucket_name/inventory_name/`.
There you will have:
* A folder with the timestamp of each export containing a `manifest.json` listing the `parquets` files of that extraction.
* The `data` folder with the data from all exports
* The `hive` data with symlinks to the dated folder

As an example here is what I got:

```plaintext
- s3://villoro/s3_inventory/villoro/villoro_inventory/
  ├── 2025-01-09T01-00Z/
  │   ├── manifest.json
  │   └── manifest.checksum
  ├── 2025-01-12T01-00Z/
  │   ├── manifest.json
  │   └── manifest.checksum
  ├── data/
  │   ├── 469e11b1-730b-487b-9110-e0fac5cb4237.parquet
  │   ├── ...
  │   └── 91ee5bf8-c053-4993-b698-ba07009b9060.parquet
  └── hive/
      ├── dt=2025-01-09-01-00/
      │   └──symlink.txt
      └── dt=2025-01-12-01-00/
          └──symlink.txt
```

And here you have an example of the first `manifest.json`:

```json
{
  "sourceBucket" : "villoro",
  "destinationBucket" : "arn:aws:s3:::villoro",
  "version" : "2016-11-30",
  "creationTimestamp" : "1736384401000",
  "fileFormat" : "Parquet",
  "fileSchema" : "message s3.inventory {  required binary bucket (STRING);  required binary key (STRING);}",
  "files" : [ {
    "key" : "s3_inventory/villoro/villoro_inventory/data/469e11b1-730b-487b-9110-e0fac5cb4237.parquet",
    "size" : 120112,
    "MD5checksum" : "f0731733165f367e93fa4a51ecc28edb"
  } ]
}
```

## 2. Automating the Inventory

### 2.1. Creating a S3 Inventory table

### 2.2. Cleaning the data with DBT

## 3. Implement S3 Lifecycle Policies

S3 Lifecycle Policies can automatically manage your objects to reduce costs. For example, you can configure policies to transition objects to cheaper storage classes or delete non-current versions of objects. Here’s how to set them up:

1. **Navigate to Lifecycle Rules:**
   * In the S3 console, go to the **Management** tab of your bucket.
   * Scroll to the **Lifecycle Rules** section and click **Create Lifecycle Rule**.

2. **Define the Rule Scope:**
   * Provide a name for the rule.
   * Specify whether the rule applies to the entire bucket or to a subset of objects (e.g., objects with a specific prefix or tag).

3. **Configure Actions:**
   * **Transition Actions:** Move objects to cheaper storage classes like S3 Standard-IA, S3 Glacier Instant Retrieval, or S3 Deep Archive after a specified number of days.
   * **Expiration Actions:** Set rules to delete objects after a certain number of days.
   * **Non-Current Version Expiration:** Automatically delete older versions of objects to save storage space.

4. **Review and Save:**
   * Review your configuration.
   * Save the rule by clicking **Create Rule**.

<Notice type="info">
  Non-current version expiration is especially useful for buckets with versioning enabled to minimize storage costs.
</Notice>

---

By combining S3 Inventory with Lifecycle Policies, you can effectively analyze and manage your storage, ensuring optimal cost efficiency. This approach not only provides visibility into your data but also automates actions to keep your storage expenses under control.
